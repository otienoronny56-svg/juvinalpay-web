<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JuvinalPay | Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-slate-900 pb-24">

    <header class="p-6 flex justify-between items-center sticky top-0 bg-slate-50/90 backdrop-blur-md z-20 border-b border-slate-200/50">
        <div>
            <p class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-1">Welcome back,</p>
            <h1 id="user-name" class="text-xl font-extrabold text-slate-900">...</h1>
        </div>
        <div class="h-10 w-10 rounded-full bg-white p-0.5 shadow-md border border-slate-100">
            <img id="user-avatar" src="https://via.placeholder.com/100" class="h-full w-full rounded-full object-cover bg-slate-100">
        </div>
    </header>

    <main class="px-6 space-y-6 mt-6">

        <div class="grid grid-cols-2 gap-4">
            <div class="col-span-2 bg-emerald-600 p-6 rounded-3xl relative overflow-hidden shadow-xl shadow-emerald-200">
                <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl text-white pointer-events-none">ðŸ’°</div>
                
                <div class="flex justify-between items-center mb-1 relative z-10">
                    <p class="text-xs font-bold text-emerald-100 uppercase tracking-widest">Available Savings</p>
                    <button onclick="toggleBalances()" id="eye-btn" class="p-2 -mr-2 text-emerald-100 hover:text-white transition-colors rounded-full hover:bg-emerald-500/20">
                        <svg id="eye-open" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" />
                            <path fill-rule="evenodd" d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 010-1.113zM17.25 12a5.25 5.25 0 11-10.5 0 5.25 5.25 0 0110.5 0z" clip-rule="evenodd" />
                        </svg>
                        <svg id="eye-closed" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 hidden">
                            <path d="M3.53 2.47a.75.75 0 00-1.06 1.06l18 18a.75.75 0 101.06-1.06l-18-18zM22.676 12.553a11.249 11.249 0 01-2.631 4.31l-3.099-3.099a5.25 5.25 0 00-6.71-6.71L7.759 4.577a11.217 11.217 0 014.242-.827c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113z" />
                            <path d="M15.75 12c0 .18-.013.357-.037.53l-4.244-4.243A3.75 3.75 0 0115.75 12zM12.53 15.713l-4.243-4.244a3.75 3.75 0 004.243 4.243z" />
                            <path d="M6.75 12c0-.619.107-1.213.304-1.764l-3.1-3.1a11.25 11.25 0 00-2.63 4.31c-.12.362-.12.752 0 1.114 1.489 4.467 5.704 7.69 10.675 7.69 1.5 0 2.933-.294 4.242-.827l-2.477-2.477A5.25 5.25 0 016.75 12z" />
                        </svg>
                    </button>
                </div>

                <h2 id="savings-balance" class="text-3xl font-black text-white relative z-10">KES ...</h2>
                <p class="text-[10px] text-emerald-100 mt-2 opacity-80 relative z-10">Ready to Withdraw</p>
            </div>

            <div class="col-span-1 bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                <div class="h-8 w-8 bg-indigo-50 rounded-xl flex items-center justify-center mb-3 text-indigo-600">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 00-5.25 5.25v3a3 3 0 00-3 3v6.75a3 3 0 003 3h10.5a3 3 0 003-3v-6.75a3 3 0 00-3-3v-3c0-2.9-2.35-5.25-5.25-5.25zm3.75 8.25v-3a3.75 3.75 0 10-7.5 0v3h7.5z" clip-rule="evenodd" />
                    </svg>
                </div>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Locked Vault</p>
                <h3 id="locked-balance" class="text-lg font-black text-slate-900">KES ...</h3>
            </div>

            <div class="col-span-1 bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                <div class="h-8 w-8 bg-amber-50 rounded-xl flex items-center justify-center mb-3 text-amber-500">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M5.625 1.5H9a3.75 3.75 0 013.75 3.75v1.875c0 1.036.84 1.875 1.875 1.875H16.5a3.75 3.75 0 013.75 3.75v7.875c0 1.035-.84 1.875-1.875 1.875H5.625a1.875 1.875 0 01-1.875-1.875V3.375c0-1.036.84-1.875 1.875-1.875zM12.75 12a.75.75 0 00-1.5 0V15H9a.75.75 0 000 1.5h2.25V18.75a.75.75 0 001.5 0V16.5H15a.75.75 0 000-1.5h-2.25V12z" clip-rule="evenodd" />
                        <path d="M14.25 5.25a5.23 5.23 0 00-1.279-3.434 9.768 9.768 0 016.963 6.963A5.23 5.23 0 0016.5 7.5h-1.875a.375.375 0 01-.375-.375V5.25z" />
                    </svg>
                </div>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Share Capital</p>
                <h3 id="share-capital" class="text-lg font-black text-slate-900">KES ...</h3>
            </div>
        </div>

        <div>
            <h3 class="text-sm font-bold text-slate-700 mb-4 px-1">Quick Actions</h3>
            <div class="grid grid-cols-4 gap-4">
                <a href="payment.html" class="flex flex-col items-center gap-2 group cursor-pointer">
                    <div class="h-14 w-14 rounded-2xl bg-white border border-slate-100 flex items-center justify-center shadow-sm group-active:scale-95 transition-all text-emerald-600">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                    </div>
                    <span class="text-[10px] font-bold text-slate-500">Deposit</span>
                </a>

                <a href="withdraw.html" class="flex flex-col items-center gap-2 group cursor-pointer">
                    <div class="h-14 w-14 rounded-2xl bg-white border border-slate-100 flex items-center justify-center shadow-sm group-active:scale-95 transition-all text-slate-600">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 ml-0.5 mt-0.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                        </svg>
                    </div>
                    <span class="text-[10px] font-bold text-slate-500">Withdraw</span>
                </a>

                <a href="transfer.html" class="flex flex-col items-center gap-2 group cursor-pointer">
                    <div class="h-14 w-14 rounded-2xl bg-white border border-slate-100 flex items-center justify-center shadow-sm group-active:scale-95 transition-all text-indigo-600">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                        </svg>
                    </div>
                    <span class="text-[10px] font-bold text-slate-500">Transact</span>
                </a>

                <a href="activity.html" class="flex flex-col items-center gap-2 group cursor-pointer">
                    <div class="h-14 w-14 rounded-2xl bg-white border border-slate-100 flex items-center justify-center shadow-sm group-active:scale-95 transition-all text-rose-600">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                        </svg>
                    </div>
                    <span class="text-[10px] font-bold text-slate-500">Activities</span>
                </a>
            </div>
        </div>

        <div class="pb-safe">
            <div class="flex justify-between items-end mb-4 px-1">
                <h3 class="text-sm font-bold text-slate-700">Recent Activity</h3>
                <a href="transactions.html" class="text-xs text-indigo-600 font-bold">See All</a>
            </div>
            
            <div id="mini-ledger" class="space-y-3">
                <div class="text-center py-8 text-xs text-slate-400">Loading history...</div>
            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 w-full bg-white border-t border-slate-100 pb-4 pt-2 px-6 flex justify-between z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <a href="dashboard.html" class="flex flex-col items-center gap-1 p-2 text-indigo-600">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                <path d="M11.47 3.84a.75.75 0 011.06 0l8.635 8.635a.75.75 0 11-1.06 1.06l-.375-.375v4.425a.75.75 0 01-.75.75H16.5V13.5a1.5 1.5 0 00-1.5-1.5h-6a1.5 1.5 0 00-1.5 1.5v4.885H4.125a.75.75 0 01-.75-.75V13.16l-.375.375a.75.75 0 11-1.06-1.06L11.47 3.84z" />
            </svg>
            <span class="text-[10px] font-bold">Home</span>
        </a>
        <a href="loans.html" class="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-slate-900 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                <path fill-rule="evenodd" d="M7.5 6v.75H5.513c-.96 0-1.764.724-1.865 1.679l-1.263 12A1.875 1.875 0 004.25 22.5h15.5a1.875 1.875 0 001.865-2.071l-1.263-12a1.875 1.875 0 00-1.865-1.679H16.5V6a4.5 4.5 0 10-9 0zM12 3a3 3 0 00-3 3v.75h6V6a3 3 0 00-3-3zm-3 8.25a3 3 0 106 0v-.75a.75.75 0 011.5 0v.75a4.5 4.5 0 11-9 0v-.75a.75.75 0 011.5 0v.75z" clip-rule="evenodd" />
            </svg>
            <span class="text-[10px] font-bold">Loans</span>
        </a>
        <a href="profile.html" class="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-slate-900 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
            </svg>
            <span class="text-[10px] font-bold">Profile</span>
        </a>
    </nav>

    <script>
        // GLOBAL STATE: Are balances hidden? (Default to false, check localStorage)
        let isBalanceHidden = localStorage.getItem('hideBalance') === 'true';
        let currentProfileData = null; // Store data so we can toggle without re-fetching

        async function init() {
            if (!window.supabaseClient) return;
            // 1. Get User
            const { data: { user } } = await window.supabaseClient.auth.getUser();
            if (!user) return window.location.href = 'login.html';

            // 2. THE BOUNCER CHECK (New Security Layer) ðŸ”’
            // We fetch the profile status before showing anything
            const { data: profile } = await window.supabaseClient
                .from('profiles')
                .select('membership_status')
                .eq('id', user.id)
                .single();

            // If they haven't paid -> Send to Payment
            if (profile.membership_status === 'pending_payment') {
                return window.location.href = 'payment.html?mode=onboarding';
            }
            // If they paid but Admin hasn't approved -> Send to Waiting Room
            if (profile.membership_status === 'pending_approval') {
                return window.location.href = 'success.html';
            }
            // If they are Banned -> Kick out
            if (profile.membership_status === 'banned') {
                await window.supabaseClient.auth.signOut();
                alert("Account Suspended. Contact Admin.");
                return window.location.href = 'login.html';
            }

            // 3. If "active", Allow Entry & Load Data
            await loadProfile(user.id);
            await loadTransactions(user.id);

            // REALTIME
            window.supabaseClient
                .channel('dashboard-realtime')
                .on(
                    'postgres_changes', 
                    { event: 'UPDATE', schema: 'public', table: 'profiles', filter: `id=eq.${user.id}` }, 
                    (payload) => {
                        updateUI(payload.new); 
                    }
                )
                .subscribe();
            
            // Set initial state of eye icon
            updateEyeIcon();
        }

        async function loadProfile(userId) {
            const { data: profile, error } = await window.supabaseClient
                .from('profiles')
                .select('full_name, avatar_url, savings_balance, locked_savings, share_capital')
                .eq('id', userId)
                .single();

            if (error) return console.error("Profile Error:", error);

            const fullName = profile.full_name || 'Member';
            document.getElementById('user-name').innerText = fullName.split(' ')[0];
            if(profile.avatar_url) document.getElementById('user-avatar').src = profile.avatar_url;

            updateUI(profile);
        }

        function toggleBalances() {
            isBalanceHidden = !isBalanceHidden;
            localStorage.setItem('hideBalance', isBalanceHidden); // Save preference
            updateEyeIcon();
            if (currentProfileData) updateUI(currentProfileData); // Re-render numbers
        }

        function updateEyeIcon() {
            const open = document.getElementById('eye-open');
            const closed = document.getElementById('eye-closed');
            if (isBalanceHidden) {
                open.classList.add('hidden');
                closed.classList.remove('hidden');
            } else {
                open.classList.remove('hidden');
                closed.classList.add('hidden');
            }
        }

        function updateUI(profileData) {
            currentProfileData = profileData; // Cache for toggling

            // Logic: If Hidden -> "****", Else -> Real Number
            const format = (amount) => isBalanceHidden ? 'KES ****' : `KES ${(amount || 0).toLocaleString()}`;

            document.getElementById('savings-balance').innerText = format(profileData.savings_balance);
            document.getElementById('locked-balance').innerText = format(profileData.locked_savings);
            document.getElementById('share-capital').innerText = format(profileData.share_capital);
        }

        async function loadTransactions(userId) {
            const { data: txs } = await window.supabaseClient
                .from('transactions')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false })
                .limit(5);

            const container = document.getElementById('mini-ledger');
            container.innerHTML = '';

            if(!txs || txs.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-xs text-slate-400">No recent transactions.</div>';
                return;
            }

            txs.forEach(tx => {
                const isPositive = tx.amount > 0 && tx.transaction_type !== 'lock';
                let amountColor = isPositive ? 'text-emerald-600' : 'text-slate-900';
                let icon = isPositive ? 'â†“' : 'â†‘';
                
                if (tx.transaction_type === 'lock') {
                    amountColor = 'text-indigo-600';
                    icon = 'ðŸ”’';
                }

                const item = document.createElement('div');
                item.className = "bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center";
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full bg-slate-50 flex items-center justify-center text-sm text-slate-500">
                            ${icon}
                        </div>
                        <div>
                            <p class="text-xs font-bold text-slate-900 capitalize">${tx.description || tx.transaction_type}</p>
                            <p class="text-[10px] text-slate-400 font-mono">${new Date(tx.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div class="text-sm font-black ${amountColor}">
                        ${isPositive ? '+' : ''}KES ${Math.abs(tx.amount).toLocaleString()}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        init();
    </script>
</body>
</html>