<!DOCTYPE html>
<html lang="en">
<head>
        <!-- Font Awesome for modern icons -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JuvinalPay | Loan Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0f172a; }
        /* Hide scrollbar for clean mobile look */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col justify-end bg-slate-900">

    <div class="bg-white rounded-t-[32px] h-[92vh] w-full flex flex-col relative animate-slide-up">
        
        <div class="w-full flex justify-center pt-6 pb-2 shrink-0">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full"></div>
        </div>

        <div class="flex-1 overflow-y-auto px-8 pb-32 no-scrollbar">

            <div id="loadingState" class="text-center py-20">
                <p class="text-slate-400 font-bold animate-pulse">Syncing Loan Data...</p>
            </div>

            <div id="activeLoanView" class="hidden flex flex-col pt-4">
                <div class="text-center mb-8">
                    <span class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest">Active Loan</span>
                    <h1 class="text-4xl font-extrabold text-slate-900 mt-4">KES <span id="owedAmount">0</span></h1>
                    <p class="text-xs text-slate-400 mt-2 font-medium">Outstanding Balance</p>
                </div>

                <div class="bg-slate-50 border border-slate-100 p-6 rounded-3xl space-y-4 mb-8">
                    <div class="flex justify-between">
                        <span class="text-xs font-bold text-slate-400 uppercase">Principal</span>
                        <span class="text-sm font-bold text-slate-900" id="principalAmt">...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-xs font-bold text-slate-400 uppercase">Interest</span>
                        <span class="text-sm font-bold text-slate-900" id="interestAmt">...</span>
                    </div>
                    <div class="border-t border-slate-200 pt-4 flex justify-between">
                        <span class="text-xs font-bold text-rose-500 uppercase">Due Date</span>
                        <span class="text-sm font-bold text-rose-500" id="dueDate">...</span>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-2 mb-2 block">Enter Repayment Amount</label>
                        <input type="number" id="repayInput" class="w-full p-5 bg-white border-2 border-slate-100 rounded-2xl font-bold text-slate-900 text-xl outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all placeholder:text-slate-300" placeholder="e.g. 500">
                    </div>
                    
                    <button onclick="repayLoan()" id="repayBtn" class="w-full bg-emerald-500 text-white font-bold py-5 rounded-2xl shadow-xl shadow-emerald-200 active:scale-95 transition-all text-lg">
                        Pay Now (M-Pesa)
                    </button>
                    <p class="text-center text-[10px] text-slate-400 font-medium pt-2">Secured by Safaricom Daraja</p>
                </div>
            </div>

            <div id="pendingView" class="hidden text-center py-10">
                <div class="h-24 w-24 bg-amber-50 text-amber-500 rounded-full flex items-center justify-center text-4xl mx-auto mb-6 shadow-sm border border-amber-100">⏳</div>
                <h2 class="text-xl font-bold text-slate-900">Application Under Review</h2>
                <p class="text-sm text-slate-500 mt-2 px-6 leading-relaxed">Your request for <span id="pendingAmt" class="font-bold text-slate-900">...</span> is waiting for admin approval.</p>
                <button onclick="location.reload()" class="mt-8 text-indigo-600 font-bold text-xs bg-indigo-50 px-4 py-2 rounded-lg hover:bg-indigo-100">Check Status</button>
            </div>

            <div id="applyView" class="hidden flex flex-col pt-4">
                <header class="text-center mb-8">
                    <h1 class="text-2xl font-extrabold text-slate-900">Request Loan</h1>
                    <p class="text-xs text-slate-400 mt-1 font-medium">Instant limits based on savings.</p>
                </header>

                <div class="bg-indigo-50 border border-indigo-100 p-5 rounded-3xl mb-8 flex justify-between items-center shadow-sm">
                    <div>
                        <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Max Limit</p>
                        <h3 id="maxLimitText" class="text-xl font-black text-indigo-900">...</h3>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Min Limit</p>
                        <h3 id="minLimitText" class="text-xl font-black text-slate-600">...</h3>
                    </div>
                </div>

                <div class="space-y-5">
                    <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100 focus-within:ring-2 focus-within:ring-indigo-500 transition-all">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Loan Amount (KES)</p>
                        <input type="number" id="loanAmount" class="w-full bg-transparent text-4xl font-extrabold text-slate-900 outline-none placeholder:text-slate-200" placeholder="0">
                    </div>

                    <div class="relative">
                        <select id="loanReason" onchange="handleReason()" class="w-full p-5 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-slate-700 outline-none appearance-none">
                            <option value="" disabled selected>Select Loan Purpose</option>
                            <option value="Business">Business Investment</option>
                            <option value="Education">Education / Fees</option>
                            <option value="Emergency">Medical Emergency</option>
                            <option value="Personal">Personal Use</option>
                            <option value="Other">Other</option>
                        </select>
                        <div class="absolute right-5 top-5 pointer-events-none text-slate-400">▼</div>
                    </div>
                    
                    <input type="text" id="otherReason" class="hidden w-full p-5 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-slate-700 outline-none" placeholder="Specific Reason...">
                    
                    <div class="flex justify-between px-2 py-2">
                         <p class="text-[10px] text-slate-400 uppercase font-bold">Total Repayment</p>
                         <p id="repaymentText" class="font-bold text-emerald-600">KES 0</p>
                    </div>

                    <button onclick="submitApplication()" id="applyBtn" class="w-full bg-slate-900 text-white font-bold py-5 rounded-2xl shadow-xl active:scale-95 transition-all mt-4">
                        Submit Application
                    </button>
                </div>
            </div>

        </div>
    </div>

    <nav class="fixed bottom-0 w-full bg-white border-t border-slate-100 pb-4 pt-2 px-6 flex justify-between z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <a href="dashboard.html" class="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-slate-900 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                <path d="M11.47 3.84a.75.75 0 011.06 0l8.635 8.635a.75.75 0 11-1.06 1.06l-.375-.375v4.425a.75.75 0 01-.75.75H16.5V13.5a1.5 1.5 0 00-1.5-1.5h-6a1.5 1.5 0 00-1.5 1.5v4.885H4.125a.75.75 0 01-.75-.75V13.16l-.375.375a.75.75 0 11-1.06-1.06L11.47 3.84z" />
            </svg>
            <span class="text-[10px] font-bold">Home</span>
        </a>
        <a href="loans.html" class="flex flex-col items-center gap-1 p-2 text-indigo-600">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                <path fill-rule="evenodd" d="M7.5 6v.75H5.513c-.96 0-1.764.724-1.865 1.679l-1.263 12A1.875 1.875 0 004.25 22.5h15.5a1.875 1.875 0 001.865-2.071l-1.263-12a1.875 1.875 0 00-1.865-1.679H16.5V6a4.5 4.5 0 10-9 0zM12 3a3 3 0 00-3 3v.75h6V6a3 3 0 00-3-3zm-3 8.25a3 3 0 106 0v-.75a.75.75 0 011.5 0v.75a4.5 4.5 0 11-9 0v-.75a.75.75 0 011.5 0v.75z" clip-rule="evenodd" />
            </svg>
            <span class="text-[10px] font-bold">Loans</span>
        </a>
        <a href="activity.html" class="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-slate-900 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                <path fill-rule="evenodd" d="M12 2.25a9.75 9.75 0 100 19.5 9.75 9.75 0 000-19.5zM12 18a6 6 0 110-12 6 6 0 010 12zm.75-9.75a.75.75 0 00-1.5 0v3.19l2.72 1.63a.75.75 0 10.76-1.29l-2.23-1.34V8.25z" clip-rule="evenodd" />
            </svg>
            <span class="text-[10px] font-bold">Activity</span>
        </a>
        <a href="profile.html" class="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-slate-900 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
            </svg>
            <span class="text-[10px] font-bold">Profile</span>
        </a>
    </nav>

    <script>
        let maxLoan=0, minLoan=0, interestRate=0, currentLoanId=null;

        async function init() {
            if (!window.supabaseClient) return;
            const { data: { user } } = await window.supabaseClient.auth.getUser();
            if (!user) return window.location.href = "login.html";

            // 1. Fetch Loan Status
            const { data: loans } = await window.supabaseClient
                .from('sacco_loans')
                .select('*')
                .eq('user_id', user.id)
                .in('loan_status', ['active', 'pending', 'pending_approval']) 
                .order('created_at', { ascending: false })
                .limit(1)
                .maybeSingle(); 

            document.getElementById('loadingState').classList.add('hidden');

            if (loans) {
                // Map status for display
                const statusMap = {
                    'pending': { color: 'text-yellow-500', label: 'Pending Review' },
                    'active':  { color: 'text-emerald-500', label: 'Active / Approved' },
                    'paid':    { color: 'text-blue-500',    label: 'Fully Paid' },
                    'rejected':{ color: 'text-red-500',     label: 'Rejected' }
                };
                const statusInfo = statusMap[loans.loan_status] || { color: 'text-slate-500', label: loans.loan_status };

                if (loans.loan_status === 'active') {
                    // --- ACTIVE LOAN SCREEN ---
                    document.getElementById('activeLoanView').classList.remove('hidden');
                    const totalRepay = Math.ceil(loans.total_repayment || loans.amount); 
                    const amount = loans.amount;
                    document.getElementById('owedAmount').innerText = totalRepay.toLocaleString();
                    document.getElementById('principalAmt').innerText = `KES ${amount.toLocaleString()}`;
                    document.getElementById('interestAmt').innerText = `KES ${(totalRepay - amount).toLocaleString()}`;
                    document.getElementById('dueDate').innerText = new Date(loans.due_date).toLocaleDateString();
                    document.getElementById('repayInput').value = totalRepay; 
                    currentLoanId = loans.id;
                    // Example: show status in UI (add where needed)
                    // document.getElementById('loanStatus').innerHTML = `<span class="${statusInfo.color} font-bold">${statusInfo.label}</span>`;
                } else {
                    // --- PENDING SCREEN ---
                    document.getElementById('pendingView').classList.remove('hidden');
                    document.getElementById('pendingAmt').innerText = `KES ${loans.amount.toLocaleString()}`;
                    // Example: show status in UI (add where needed)
                    // document.getElementById('loanStatus').innerHTML = `<span class="${statusInfo.color} font-bold">${statusInfo.label}</span>`;
                }
            } else {
                // --- APPLY SCREEN ---
                loadApplicationLogic(user.id);
            }
        }

        async function loadApplicationLogic(userId) {
            document.getElementById('applyView').classList.remove('hidden');
            
            const { data: config } = await window.supabaseClient.from('sacco_configs').select('*').single();
            minLoan = config?.min_loan_amount || 10;
            interestRate = config?.loan_interest_rate || 5;
            document.getElementById('minLimitText').innerText = `KES ${minLoan}`;

            const { data: profile } = await window.supabaseClient.from('profiles').select('savings_balance').eq('id', userId).single();
            maxLoan = (profile?.savings_balance || 0) * 3;
            document.getElementById('maxLimitText').innerText = `KES ${maxLoan.toLocaleString()}`;

            document.getElementById('loanAmount').addEventListener('input', (e) => {
                const amt = parseFloat(e.target.value) || 0;
                const total = amt + (amt * (interestRate / 100));
                document.getElementById('repaymentText').innerText = `KES ${total.toLocaleString()}`;
            });
        }

        function handleReason() {
            const val = document.getElementById('loanReason').value;
            if(val === 'Other') document.getElementById('otherReason').classList.remove('hidden');
            else document.getElementById('otherReason').classList.add('hidden');
        }

        async function submitApplication() {
            const amount = parseFloat(document.getElementById('loanAmount').value);
            let reason = document.getElementById('loanReason').value;
            if(reason === 'Other') reason = document.getElementById('otherReason').value;

            if (!amount || amount < minLoan) return alert(`Minimum: KES ${minLoan}`);
            if (amount > maxLoan) return alert(`Max Limit: KES ${maxLoan}`);
            if (!reason) return alert("Select a reason.");

            const btn = document.getElementById('applyBtn');
            btn.innerText = "Submitting..."; btn.disabled = true;

            const { data: { user } } = await window.supabaseClient.auth.getUser();
            const { data: profile } = await window.supabaseClient.from('profiles').select('phone_number').eq('id', user.id).single();

            const { error } = await window.supabaseClient.from('sacco_loans').insert({
                user_id: user.id,
                amount: amount,
                loan_status: 'pending_approval',
                mpesa_number: profile.phone_number,
                loan_reason: reason,
                due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)
            });

            if(error) {
                alert(error.message);
                btn.innerText = "Submit Application"; 
                btn.disabled = false;
            } else {
                location.reload(); 
            }
        }

        async function repayLoan() {
            const amount = document.getElementById('repayInput').value;
            if(!amount || amount <= 0) return alert("Please enter a valid amount");
            
            const btn = document.getElementById('repayBtn');
            const originalText = btn.innerText;
            btn.innerText = "Sending M-Pesa Request..."; 
            btn.disabled = true;

            const { data: { user } } = await window.supabaseClient.auth.getUser();
            const { data: profile } = await window.supabaseClient.from('profiles').select('phone_number').eq('id', user.id).single();
            
            // Format phone: remove 0 or +254, add 254
            let phone = profile.phone_number.replace(/\D/g, ''); // Remove non-digits
            if (phone.startsWith('0')) phone = '254' + phone.substring(1);
            if (phone.startsWith('254')) phone = phone; // already good

            const { data, error } = await window.supabaseClient.functions.invoke('stk-push', {
                body: { 
                    phone: phone, 
                    amount: parseInt(amount), 
                    depositType: 'loan_repayment' 
                }
            });
            
            if(data?.CheckoutRequestID) {
                // Record the intent so we can track it
                await window.supabaseClient.from('payment_requests').insert({
                    checkout_request_id: data.CheckoutRequestID,
                    user_id: user.id,
                    amount: parseInt(amount),
                    intent: 'loan_repayment'
                });
                alert("✓ STK Push Sent!\n\nCheck your phone to enter your PIN.");
                btn.innerText = "Waiting for Payment...";
            } else {
                alert("Connection Error. Please try again.");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        init();
    </script>
</body>
</html>